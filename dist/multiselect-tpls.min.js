angular.module("oi.multiselect",["template/multiselect/template.html"]),angular.module("template/multiselect/template.html",[]).run(["$templateCache",function(a){a.put("template/multiselect/template.html",'<div class="multiselect-search" ng-class="{open: isOpen, focused: isFocused}" ng-click="setFocus($event)">\n    <ul class="multiselect-search-list">\n        <li class="btn btn-default btn-xs multiselect-search-list-item multiselect-search-list-item_selection"\n            ng-repeat="item in output track by $index"\n            ng-class="{focused: backspaceFocus && $last}"\n            ng-click="removeItem($index)"\n            ng-bind-html="getSearchLabel(item)"></li>\n        <li class="multiselect-search-list-item multiselect-search-list-item_input"><input autocomplete="off"\n                                                                                           ng-model="query"\n                                                                                           ng-style="{\'width\': inputWidth + \'px\'}"\n                                                                                           ng-keydown="keyParser($event)"/></li>\n        <li class="multiselect-search-list-item multiselect-search-list-item_loader" ng-show="showLoader"></li>\n    </ul>\n</div>\n<div class="multiselect-dropdown" ng-show="isOpen" ng-click="setFocus($event)">\n    <ul ng-if="isOpen" class="multiselect-dropdown-optgroup" ng-repeat="(group, options) in groups">\n        <div class="multiselect-dropdown-optgroup-header"\n            ng-if="group && options.length"\n            ng-bind="group"></div><!-- we use fast getElementsByTagName(\'li\')-->\n        <li class="multiselect-dropdown-optgroup-option"\n            ng-repeat="option in options"\n            ng-class="{\'active\': selectorPosition === groupPos[group] + $index}"\n            ng-click="addItem(option)"\n            ng-mouseenter="setSelection(groupPos[group] + $index)"\n            ng-bind-html="getDropdownLabel(option)"></li>\n    </ul>\n</div>')}]),angular.module("oi.multiselect").provider("oiMultiselect",function(){return{options:{debounce:500,searchFilter:"oiMultiselectCloseIcon",dropdownFilter:"oiMultiselectHighlight"},$get:function(){return{options:this.options}}}}).factory("oiUtils",["$document",function(a){function b(b,d){var e=angular.element("<mirror>").css({position:"absolute",width:"auto",padding:0,whiteSpace:"pre",visibility:"hidden","z-index":-99999}).text(b||"");c(d,e,"letterSpacing fontSize fontFamily fontWeight textTransform".split(" ")),a[0].body.appendChild(e[0]);var f=e[0].offsetWidth;return e.remove(),f}function c(a,b,c){for(var d={},e=getComputedStyle(a[0],""),f=0,g=c.length;g>f;f++)d[c[f]]=e[c[f]];b.css(d)}function d(a,b){var c,d,e,g,i,j;b&&(d=a.offsetHeight,e=h(b,"height","margin"),g=a.scrollTop||0,c=f(b).top-f(a).top+g,i=c,j=c-d+e,c+e>d+g?a.scrollTop=j:g>c&&(a.scrollTop=i))}function e(a,b,c,d,e){function f(a){return parseFloat(e[a])}for(var g=c===(d?"border":"content")?4:"width"===b?1:0,h=0,i=["Top","Right","Bottom","Left"];4>g;g+=2)"margin"===c&&(h+=f(c+i[g])),d?("content"===c&&(h-=f("padding"+i[g])),"margin"!==c&&(h-=f("border"+i[g]+"Width"))):(h+=f("padding"+i[g]),"padding"!==c&&(h+=f("border"+i[g]+"Width")));return h}function f(a){var b,c,d=a.getBoundingClientRect(),e=a&&a.ownerDocument;if(e)return b=e.documentElement,c=g(e),{top:d.top+c.pageYOffset-b.clientTop,left:d.left+c.pageXOffset-b.clientLeft}}function g(a){return null!=a&&a===a.window?a:9===a.nodeType&&a.defaultView}function h(a,b,c){var d=!0,f="width"===b?a.offsetWidth:a.offsetHeight,g=window.getComputedStyle(a,null),h=!1;if(0>=f||null==f){if(f=g[b],(0>f||null==f)&&(f=a.style[b]),m.test(f))return f;f=parseFloat(f)||0}return f+e(a,b,c||(h?"border":"content"),d,g)}function i(a,b){b.css("width",h(a[0],"width","margin")+"px")}function j(a){for(var b in a)if(a.hasOwnProperty(b)&&a[b].length)return!1;return!0}function k(a){var b=[];return angular.forEach(a,function(a){b.push(a)}),b}var l=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,m=new RegExp("^("+l+")(?!px)[a-z%]+$","i");return{copyWidth:i,measureString:b,scrollActiveOption:d,groupsIsEmpty:j,objToArr:k}}]),angular.module("oi.multiselect").directive("oiMultiselect",["$document","$q","$timeout","$parse","$interpolate","$filter","oiUtils","oiMultiselect",function(a,b,c,d,e,f,g,h){var i=/^\s*([\s\S]+?)(?:\s+as\s+([\s\S]+?))?(?:\s+group\s+by\s+([\s\S]+?))?\s+for\s+(?:([\$\w][\$\w]*)|(?:\(\s*([\$\w][\$\w]*)\s*,\s*([\$\w][\$\w]*)\s*\)))\s+in\s+([\s\S]+?)(?:\s+track\s+by\s+([\s\S]+?))?$/,j=/([^\(\)\s\|\s]*)\s*(\(.*\))?\s*(\|?\s*.+)?/;return{restrict:"AE",templateUrl:"template/multiselect/template.html",require:"ngModel",scope:{},compile:function(k,l){var m,n=l.ngOptions;if(!(m=n.match(i)))throw new Error("Expected expression in form of '_select_ (as _label_)? for (_key_,)?_value_ in _collection_'");var o,p=m[2]||m[1],q=m[4]||m[6],r=m[3]||"",s=m[8]||p,t=m[7].match(j),u=t[1],v=u+(t[3]||""),w=u+(t[2]||""),x=d(p),y=d(r),z=d(v),A=d(w),B=d(s),C={},D=angular.isDefined(l.multiple),E=Number(l.multipleLimit),F=e(l.placeholder||""),G=d(l.oiMultiselectOptions),H=!1,I=!1;return function(d,e,i,j){function k(b){b.target.ownerDocument.activeElement!==M[0]&&(v(),a.off("click",k),d.isFocused=!1,d.$digest())}function l(){var a=j.$modelValue&&j.$modelValue.length?"":O;M.attr("placeholder",a),d.inputWidth=g.measureString(d.query||a,M)+4}function m(a){return C={},C[q]=a,B(d,C)}function n(a){return C={},u.split(".").reduce(function(b,c,d,e){return b[c]=d<e.length-1?{}:a},C),z(d.$parent,C)}function p(a){return C={},C[q]=a,x(d,C)}function r(a){return C={},C[q]=a,y(d,C)||""}function s(a){var e=A(d.$parent,{$query:a}),f=0;d.selectorPosition=0,a||(d.oldQuery=null),o&&angular.isFunction(e.then)&&(c.cancel(o),f=P.debounce),o=c(function(){d.showLoader=!0,b.when(e).then(function(b){d.groups=J(n(K(b,a))),t()}).finally(function(){d.showLoader=!1})},f)}function t(){var a,b,c,e=[],f=0;d.order=[],d.groupPos={};for(b in d.groups)d.groups.hasOwnProperty(b)&&"$"!=b.charAt(0)&&e.push(b);for(e.sort(),a=0;a<e.length;a++)b=e[a],c=d.groups[b],d.order=d.order.concat(c),d.groupPos[b]=f,f+=c.length}function v(){d.oldQuery=null,d.backspaceFocus=!1,d.query="",d.groups={},d.order=[],d.showLoader=!1,d.isOpen=!1,o&&c.cancel(o)}function w(a,b){d.selectorPosition=b,g.scrollActiveOption(a[0],a.find("li")[b])}function J(a){for(var b,c,d={"":[]},e=0;e<a.length;e++)b=r(a[e]),(c=d[b])||(c=d[b]=[]),c.push(a[e]);return d}function K(a,b){var c,d,e=[],f=[],h=[],i=angular.isArray(a)?a:g.objToArr(a);if(b){for(c=0;c<i.length;c++)p(i[c]).match(new RegExp(b,"i"))&&e.push(i[c]);for(c=0;c<e.length;c++)p(e[c]).match(new RegExp("^"+b,"i"))?f.push(e[c]):h.push(e[c]);d=f.concat(h)}else d=[].concat(i);return L(d),d}function L(a){var b,c,e=[].concat(d.output);for(b=0;b<a.length;b++)for(c=0;c<e.length;c++)if(m(a[b])===m(e[c])){a.splice(b,1),e.splice(c,1),b--;break}}var M=e.find("input"),N=angular.element(e[0].querySelector(".multiselect-dropdown")),O=F(d),P=angular.extend({},h.options,G(d));angular.isDefined(i.autofocus)&&c(function(){M[0].focus()}),angular.isDefined(i.readonly)&&M.attr("readonly",!0),i.$observe("disabled",function(a){M.prop("disabled",a)}),d.$parent.$watch(i.ngModel,function(a){l(),d.output=D?a:a?[a]:[]}),d.$watch("query",function(a,b){l(),a===b||d.oldQuery&&!a||I||(N[0].scrollTop=0,a?(s(a),d.oldQuery=null):(v(),I=!0)),I=!1}),d.$watch("groups",function(b){g.groupsIsEmpty(b)?d.isOpen=!1:d.isOpen||i.disabled||(d.isOpen=!0,g.copyWidth(e,N),d.isFocused||(a.on("click",k),d.isFocused=!0))}),d.setFocus=function(a){i.disabled||(angular.element(a.target).scope()===this&&(d.isOpen?v():s(d.query)),d.backspaceFocus=!1,"INPUT"!==a.target.nodeName&&M[0].focus())},d.addItem=function(a){if(isNaN(E)||!(d.output.length>=E)){var b=d.groups[r(a)];b.splice(b.indexOf(a),1),D?(j.$setViewValue(angular.isArray(j.$modelValue)?j.$modelValue.concat(a):[a]),t()):(j.$setViewValue(a),v()),g.groupsIsEmpty(d.groups)&&(d.groups={}),d.oldQuery=d.oldQuery||d.query,d.query="",d.backspaceFocus=!1,l()}},d.removeItem=function(a){i.disabled||(D?(j.$modelValue.splice(a,1),j.$setViewValue([].concat(j.$modelValue))):angular.isDefined(i.notempty)||j.$setViewValue(void 0),d.query="",(d.isOpen||d.oldQuery||!D)&&s(d.oldQuery),l())},d.setSelection=function(a){H||d.selectorPosition===a?H=!1:w(N,a)},d.keyParser=function(a){var b=0,c=d.order.length-1;switch(a.keyCode){case 38:w(N,d.selectorPosition===b?c:d.selectorPosition-1),H=!0;break;case 40:w(N,d.selectorPosition===c?b:d.selectorPosition+1),H=!0,d.query.length||d.isOpen||s();break;case 37:case 39:break;case 13:g.groupsIsEmpty(d.groups)||(d.addItem(d.order[d.selectorPosition]),d.selectorPosition===c&&w(N,0));break;case 27:v();break;case 8:if(!d.query.length){if(d.backspaceFocus&&d.output&&(d.removeItem(d.output.length-1),!d.output.length)){s();break}d.backspaceFocus=!d.backspaceFocus;break}default:return d.backspaceFocus=!1,!1}},d.getSearchLabel=function(a){var b=p(a);return P.searchFilter&&(b=f(P.searchFilter)(b,d.oldQuery||d.query,a)),b},d.getDropdownLabel=function(a){var b=p(a);return P.dropdownFilter&&(b=f(P.dropdownFilter)(b,d.oldQuery||d.query,a)),b},D&&(j.$isEmpty=function(a){return!a||!a.length}),v()}}}}]),angular.module("oi.multiselect").filter("oiMultiselectCloseIcon",["$sce",function(a){return function(b){var c='<span class="close multiselect-search-list-item_selection-remove">Ã—</span>';return a.trustAsHtml(b+c)}}]).filter("oiMultiselectHighlight",["$sce",function(a){return function(b,c){var d;return c.length>0||angular.isNumber(c)?(b=b.toString(),c=c.toString(),d=b.replace(new RegExp(c,"gi"),"<strong>$&</strong>")):d=b,a.trustAsHtml(d)}}]);